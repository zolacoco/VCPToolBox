# 插件：工作区动态注入 (Workspace Injector)

**版本:3.6.0**

## 1. 功能简介

本插件是一个 **消息预处理器 (`messagePreprocessor`)**。

它的核心功能是允许您通过一个简单的占位符，将您电脑上任意项目文件夹的完整目录结构，动态地注入到AI的系统提示词中。这能极大地帮助AI理解项目代码的全局上下文。

运作机制：替换所有 system prompt 中的 `{{Workspace::别名或路径::深度}}` 占位符。

- **占位符格式**: `{{Workspace::别名或路径::深度}}`
  - `别名或路径`: (必需) 要注入的文件夹的别名或绝对路径。
  - `深度`: (可选) 一个数字，用于限制文件树的展示深度，避免因文件过多导致上下文爆炸。

## 2. 安装与依赖

### 2.1. 插件安装
1.  确保 `WorkspaceInjector` 整个文件夹位于VCP项目的 `Plugin/` 目录下。
2.  重启VCP服务。服务在启动时会自动加载本插件。

### 2.2. 依赖安装 (重要)
为了支持忽略文件功能，本插件需要一个第三方库。请在 VCPToolBox 项目根目录下打开终端，并执行以下命令：
```shell
npm install ignore
```

## 3. 配置方法 (用于别名)

如果您希望为常用的文件夹设置一个简短的“别名”，可以按以下步骤配置。

1.  打开VCP项目根目录下的主配置文件 `config.env`。
2.  在文件中添加或修改 `WORKSPACE_ALIASES` 这一行。
3.  **格式**: 该配置项的值是一个 **JSON字符串**，其中：
    -   `"键"` 是您自定义的**别名** (例如: `"w"`, `"project"`).
    -   `"值"` 是该别名指向的文件夹的**绝对路径**。
4.  **重要提示**: 在JSON字符串中，路径的反斜杠 `\` 必须进行转义，即写成 `\\`。

**配置示例：**

```env
# config.env
# ... 其他配置 ...
# 工作区路径别名, JSON格式.
WORKSPACE_ALIASES={"w": "D:\\VCPToolBox", "docs": "C:\\Users\\YourName\\Documents"}
```

## 4. 使用方法

插件支持四种方式进行工作区注入：

### 4.1. 方式一：使用别名 (适合固定项目)

这种方式需要预先完成第3节的配置。

**示例**:
在一个Agent的系统提示词中写入：
> 你是一个VCP框架的开发专家。这是当前VCP项目的完整文件结构，请你熟悉它：
> {{Workspace::w}}

插件会自动将 `w` 替换为 `D:\VCPToolBox` 文件夹的完整目录树。

要了解如何限制深度，请参考 **4.4. 方式四**。

### 4.2. 方式二：使用直接路径 (适合临时任务)

您可以直接在提示词的占位符中填入文件夹的绝对路径，无需任何配置和重启，非常方便。

**场景示例**:
假设您想让AI分析 `D:\software\VCPToolBox\Agent` 文件夹，但并未为其设置别名。您可以直接在提示中这样写入：

```

这是agent文件夹的结构：
{{Workspace::D:\software\VCPToolBox\Agent}}

```
插件会自动识别这是一个直接路径，并动态抓取其目录结构进行注入。

要了解如何限制深度，请参考 **4.4. 方式四**。

### 4.3. 方式三：使用别名/子目录组合 (新功能)

这是最灵活的用法。您可以将一个配置好的别名作为根目录，然后在其后附加任意层级的子目录。

**场景示例**:
假设您在 `config.env` 中已配置别名 `"w": "D:\\VCPToolBox"`。现在您想注入 `Agent` 子目录。

您可以这样写入：
```
{{Workspace::w/Agent}}
```
插件会自动解析为 `D:\VCPToolBox\Agent` 目录。支持多层子目录，例如 `{{Workspace::w/Plugin/WorkspaceInjector}}` 也是完全有效的。

要了解如何限制深度，请参考 **4.4. 方式四**。

### 4.4. 方式四：限制目录深度

为了防止大型项目的文件树过长导致Token爆炸，您可以在占位符的末尾添加 `::深度` 来限制目录的递归层数。

- `::1` 表示只显示根目录下的文件和文件夹。
- `::2` 表示显示到第二层级的目录，以此类推。
- 如果不提供深度，则默认显示完整的文件树。

**示例1：使用别名并限制深度为2**

```
{{Workspace::w::2}}
```
这将只显示 `D:\VCPToolBox` 目录及其下一级子目录的内容。

**示例2：使用直接路径并限制深度为1**

```
{{Workspace::D:\software\VCPToolBox\Plugin::1}}
```
这将只显示 `Plugin` 文件夹下有哪些插件目录，但不会显示每个插件目录内部的文件。

**示例3：使用别名/子目录组合并限制深度**
```
{{Workspace::w/Agent::1}}
```
这将只显示 `D:\VCPToolBox\Agent` 目录下的文件和文件夹。

## 5. 忽略文件 (`.workspaceignore`)

本插件支持通过在工作区根目录放置一个名为 `.workspaceignore` 的文件来排除特定的文件和文件夹，使其不出现在生成的文件树中。

该文件的规则和语法与 Git 的 `.gitignore` 文件完全相同。

#### 示例 `.workspaceignore` 文件内容：
```gitignore
# 忽略所有 node_modules 目录
node_modules/

# 忽略所有 .log 文件
*.log

# 忽略项目根目录下的 temp 文件夹
/temp/

# 忽略所有名为 secret.json 的文件
secret.json

# 支持中文路径和文件名
临时文件/
*.tmp
```

#### ⚠️ 注意：处理特殊字符

如果您的文件名或文件夹名本身包含 `.gitignore` 语法中的特殊字符（例如 `[` `]` `*` `?`），您需要在使用它们作为忽略规则时进行转义，即在特殊字符前添加一个反斜杠 `\`。

**示例**：
要忽略一个名为 `[废案]工作区动态注入/` 的文件夹，正确的写法是：
```gitignore
\[废案\]工作区动态注入/
```

## 6. 调试模式 (Debug Mode)

本插件内置了详细的调试模式，方便开发者追踪插件的执行流程。

**如何开启**:
1.  在 `Plugin/WorkspaceInjector/` 文件夹内，找到 `.env` 文件 (如果不存在，VCP会自动创建，内容为 `WORKSPACE_INJECTOR_DEBUG=false`)。
2.  将文件中的 `WORKSPACE_INJECTOR_DEBUG=false` 修改为 `WORKSPACE_INJECTOR_DEBUG=true`。
3.  重启VCP服务。

开启后，每当插件运行时，它都会在VCP的控制台打印出详细的执行步骤，包括它接收到的消息内容、找到的占位符、解析的路径等，有助于快速定位问题。默认情况下，该功能为关闭 (`false`)。
